<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›è°ƒæœºåˆ¶ä¸æµå¼è¾“å‡º - LangChain å­¦ä¹  09</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            position: relative;
        }

        /* æµ®åŠ¨å…‰çƒ */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, rgba(59, 130, 246, 0.1) 50%, transparent 70%);
            top: -200px;
            right: -200px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, rgba(168, 85, 247, 0.1) 50%, transparent 70%);
            bottom: -150px;
            left: -150px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.1); }
            50% { transform: translate(-20px, 20px) scale(0.9); }
            75% { transform: translate(-30px, -20px) scale(1.05); }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #a78bfa 0%, #60a5fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(167, 139, 250, 0.3);
        }

        .header p {
            font-size: 1.3em;
            color: rgba(226, 232, 240, 0.8);
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6 0%, #a855f7 50%, #d946ef 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* åœºæ™¯å®¹å™¨ */
        .scene {
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scene.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* åœºæ™¯æ ‡é¢˜ */
        .scene-title {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(135deg, #a78bfa 0%, #60a5fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ç”»å¸ƒå®¹å™¨ */
        .canvas-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        /* å›è°ƒæµç¨‹å›¾ */
        .callback-flow {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 40px;
            flex-wrap: wrap;
        }

        .flow-step {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            min-width: 180px;
            transition: all 0.6s;
            transform: scale(0.8);
            opacity: 0;
            position: relative;
        }

        .flow-step.visible {
            transform: scale(1);
            opacity: 1;
        }

        .flow-step.active-step {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.7);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }

        .flow-arrow {
            font-size: 2em;
            color: #8b5cf6;
            opacity: 0;
            transition: all 0.6s;
        }

        .flow-arrow.visible {
            opacity: 1;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .flow-step h4 {
            color: #a78bfa;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .flow-step p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.9em;
        }

        /* å›è°ƒæ—¥å¿—æ¼”ç¤º */
        .callback-log-demo {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid #8b5cf6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.4s;
        }

        .log-entry.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .log-entry.start {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .log-entry.token {
            border-left-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .log-entry.end {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .log-timestamp {
            color: #64748b;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .log-event {
            color: #60a5fa;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .log-details {
            color: rgba(226, 232, 240, 0.8);
            line-height: 1.6;
        }

        .token-stream {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .token-badge {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.85em;
            color: #fbbf24;
            animation: tokenPop 0.3s ease-out;
        }

        @keyframes tokenPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* æµå¼è¾“å‡ºæ¼”ç¤º */
        .streaming-demo {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .streaming-output {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            line-height: 1.8;
            color: #a78bfa;
            position: relative;
        }

        .streaming-output .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #a78bfa;
            animation: blink 0.7s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .streaming-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .demo-btn {
            padding: 12px 30px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 10px;
            color: #a78bfa;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .demo-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .demo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Token è¿½è¸ª */
        .token-tracker {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
        }

        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card.updated {
            transform: scale(1.05);
            border-color: #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #a78bfa;
            margin: 10px 0;
        }

        .stat-label {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.9em;
        }

        .token-item {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(-50px);
            opacity: 0;
            transition: all 0.5s;
        }

        .token-item.visible {
            transform: translateX(0);
            opacity: 1;
        }

        .token-number {
            background: #8b5cf6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .token-text {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            color: #a78bfa;
        }

        /* ä»£ç å— */
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-block pre {
            margin: 0;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .code-block code {
            color: #e2e8f0;
        }

        .keyword { color: #c792ea; font-weight: bold; }
        .string { color: #c3e88d; }
        .comment { color: #546e7a; font-style: italic; }
        .function { color: #82aaff; }

        /* ç‰¹æ€§å¡ç‰‡ */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transform: translateY(30px);
            opacity: 0;
            transition: all 0.6s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .feature-card:hover {
            background: rgba(139, 92, 246, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .feature-card h4 {
            color: #a78bfa;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .feature-card p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.95em;
            line-height: 1.6;
        }

        /* é«˜äº®æ¡† */
        .highlight-box {
            background: rgba(139, 92, 246, 0.15);
            border-left: 5px solid #8b5cf6;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            animation: slideInRight 0.8s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .highlight-box h3 {
            color: #a78bfa;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .highlight-box p {
            line-height: 1.8;
            color: rgba(226, 232, 240, 0.9);
        }

        /* å¯¼èˆªæŒ‰é’® */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 60px;
            gap: 20px;
        }

        .nav-btn {
            padding: 15px 40px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            color: #a78bfa;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        /* é’ˆå¯¹ a æ ‡ç­¾çš„å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .nav-btn.back-to-list {
            text-decoration: none;
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .nav-btn.back-to-list:hover {
            background: rgba(59, 130, 246, 0.4);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-btn.next {
            margin-left: auto;
        }

        /* åœºæ™¯æŒ‡ç¤ºå™¨ */
        .scene-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 40px 0;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .indicator.active {
            background: #8b5cf6;
            transform: scale(1.3);
        }

        .indicator:hover {
            transform: scale(1.2);
        }

        /* å›è°ƒäº‹ä»¶åˆ—è¡¨ */
        .callback-events {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #8b5cf6;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.5s;
        }

        .event-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .event-card:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: translateX(5px);
        }

        .event-card h4 {
            color: #a78bfa;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .event-card p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 0.9em;
            line-height: 1.6;
        }

        /* åº”ç”¨åœºæ™¯ */
        .use-case-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .use-case {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 15px;
            padding: 25px;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s;
        }

        .use-case.visible {
            transform: scale(1);
            opacity: 1;
        }

        .use-case:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }

        .use-case h4 {
            color: #22c55e;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .use-case p {
            color: rgba(226, 232, 240, 0.8);
            line-height: 1.7;
            font-size: 0.95em;
        }

        /* å›åˆ°é¦–é¡µé“¾æ¥ */
        .home-link {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 10px;
            color: #a78bfa;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 100;
        }

        .home-link:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .callback-flow {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }
        }
    
        /* æ ‡å‡†å¯¼èˆªæ ·å¼ */
        .nav-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-card a {
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-card a:hover {
            transform: translateY(-2px);
        }

        /* é¡¶éƒ¨å¯¼èˆªå¡ç‰‡ */
        .top-nav-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px 24px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .top-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .top-nav-left,
        .top-nav-center,
        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .top-nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .top-nav-link:hover {
            color: #e5e7eb;
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .top-nav-link.home {
            color: #4ade80;
        }

        .top-nav-link.home:hover {
            color: #86efac;
        }

        .top-nav-link svg {
            width: 20px;
            height: 20px;
        }

        .top-nav-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
        }

        .top-nav-text {
            color: #6b7280;
            font-size: 0.9em;
        }

        .top-nav-progress {
            color: #9ca3af;
            font-size: 0.9em;
            font-weight: 500;
        }
</style>
</head>
<body>
    <!-- æµ®åŠ¨å…‰çƒ -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>    <!-- é¡¶éƒ¨å¯¼èˆª - è·¨æ¨¡å— -->
    <div class="top-nav-card">
        <div class="top-nav-container">
            <div class="top-nav-left">
                <a href="index.html" class="top-nav-link home">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    è¿”å›LangChainç›®å½•
                </a>
            </div>
            <div class="top-nav-center">
                <a href="08-output-parsers-advanced-demo.html" class="top-nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    ä¸Šä¸€è¯¾
                </a>
                <div class="top-nav-divider"></div>
                <a href="10-complete-rag-app-demo.html" class="top-nav-link">
                    ä¸‹ä¸€è¯¾
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </a>
            </div>
            <div class="top-nav-right">
                <span class="top-nav-progress">è¯¾ç¨‹ 9 / 20</span>
            </div>
        </div>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- å›åˆ°é¦–é¡µ -->
    <a href="index.html" class="home-link">â† è¿”å›é¦–é¡µ</a>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>âš¡ å›è°ƒæœºåˆ¶ä¸æµå¼è¾“å‡º</h1>
            <p>å®æ—¶ç›‘æ§å’Œå“åº”ï¼šè®© LLM åº”ç”¨æ›´æ™ºèƒ½</p>
        </div>

        <!-- åœºæ™¯ 1: ä»€ä¹ˆæ˜¯å›è°ƒ -->
        <div class="scene active" id="scene1">
            <h2 class="scene-title">ğŸ“ ä»€ä¹ˆæ˜¯å›è°ƒï¼ˆCallbacksï¼‰ï¼Ÿ</h2>

            <div class="highlight-box">
                <h3>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h3>
                <p>
                    å›è°ƒæ˜¯ä¸€ç§<strong>äº‹ä»¶é©±åŠ¨æœºåˆ¶</strong>ï¼Œå…è®¸ä½ åœ¨ LLM è°ƒç”¨çš„ä¸åŒé˜¶æ®µ<strong>æ’å…¥è‡ªå®šä¹‰é€»è¾‘</strong>ã€‚<br><br>
                    å°±åƒå¿«é€’é…é€è¿‡ç¨‹ä¸­çš„çŸ­ä¿¡é€šçŸ¥ï¼š<br>
                    â€¢ è®¢å•å·²æ¥æ”¶ â†’ on_llm_start<br>
                    â€¢ åŒ…è£¹è¿è¾“ä¸­ â†’ on_llm_new_token<br>
                    â€¢ ç­¾æ”¶å®Œæˆ â†’ on_llm_end<br><br>
                    <strong>è®©ä½ å®æ—¶æŒæ¡ LLM çš„æ‰§è¡ŒçŠ¶æ€ï¼</strong>
                </p>
            </div>

            <div class="callback-flow">
                <div class="flow-step" data-delay="0">
                    <h4>ğŸ¯ è§¦å‘è¯·æ±‚</h4>
                    <p>ç”¨æˆ·å‘èµ· LLM è°ƒç”¨</p>
                </div>

                <div class="flow-arrow" data-delay="200">â†’</div>

                <div class="flow-step" data-delay="400">
                    <h4>ğŸ“¡ å¼€å§‹å›è°ƒ</h4>
                    <p>on_llm_start è§¦å‘</p>
                </div>

                <div class="flow-arrow" data-delay="600">â†’</div>

                <div class="flow-step" data-delay="800">
                    <h4>âš¡ ç”Ÿæˆä¸­</h4>
                    <p>on_llm_new_token æŒç»­è§¦å‘</p>
                </div>

                <div class="flow-arrow" data-delay="1000">â†’</div>

                <div class="flow-step" data-delay="1200">
                    <h4>âœ… å®Œæˆå›è°ƒ</h4>
                    <p>on_llm_end è§¦å‘</p>
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card" data-delay="0">
                    <div class="feature-icon">ğŸ”</div>
                    <h4>å®æ—¶ç›‘æ§</h4>
                    <p>è¿½è¸ª LLM çš„æ¯ä¸ªæ‰§è¡Œé˜¶æ®µ</p>
                </div>

                <div class="feature-card" data-delay="100">
                    <div class="feature-icon">ğŸ“Š</div>
                    <h4>æ€§èƒ½åˆ†æ</h4>
                    <p>æµ‹é‡å“åº”æ—¶é—´å’Œèµ„æºæ¶ˆè€—</p>
                </div>

                <div class="feature-card" data-delay="200">
                    <div class="feature-icon">ğŸ’°</div>
                    <h4>æˆæœ¬è¿½è¸ª</h4>
                    <p>ç»Ÿè®¡ token ä½¿ç”¨é‡å’Œ API æˆæœ¬</p>
                </div>

                <div class="feature-card" data-delay="300">
                    <div class="feature-icon">ğŸ›</div>
                    <h4>è°ƒè¯•è¾…åŠ©</h4>
                    <p>æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—</p>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯ 2: å›è°ƒå¤„ç†æµç¨‹ -->
        <div class="scene" id="scene2">
            <h2 class="scene-title">ğŸ”„ å›è°ƒå¤„ç†æµç¨‹å¯è§†åŒ–</h2>

            <div class="highlight-box">
                <h3>ğŸ’¡ å›è°ƒæœºåˆ¶å®æˆ˜æ¼”ç¤º</h3>
                <p>
                    ç‚¹å‡»"æ’­æ”¾å®Œæ•´å›è°ƒæµç¨‹"æŸ¥çœ‹çœŸå®çš„å›è°ƒæ‰§è¡Œè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
                    <strong style="color: #3b82f6;">on_llm_start</strong>ã€
                    <strong style="color: #fbbf24;">on_llm_new_token</strong>ã€
                    <strong style="color: #22c55e;">on_llm_end</strong>
                </p>
                <button class="demo-btn" id="startFlowBtn">â–¶ï¸ æ’­æ”¾å®Œæ•´å›è°ƒæµç¨‹</button>
            </div>

            <div class="canvas-container">
                <div id="flowAnimation" class="callback-flow">
                    <div class="flow-step" id="step1">
                        <h4>ğŸ¯ ç”¨æˆ·è¯·æ±‚</h4>
                        <p>"è§£é‡Šä»€ä¹ˆæ˜¯ Python"</p>
                    </div>

                    <div class="flow-arrow" id="arrow1">â†’</div>

                    <div class="flow-step" id="step2">
                        <h4>ğŸ“¡ on_llm_start</h4>
                        <p>è®°å½•å¼€å§‹æ—¶é—´<br>æ‰“å°æç¤ºè¯</p>
                    </div>

                    <div class="flow-arrow" id="arrow2">â†’</div>

                    <div class="flow-step" id="step3">
                        <h4>ğŸ¤– LLM å¤„ç†</h4>
                        <p>ç”Ÿæˆå“åº”å†…å®¹<br>é€ä¸ª token è¿”å›</p>
                    </div>

                    <div class="flow-arrow" id="arrow3">â†’</div>

                    <div class="flow-step" id="step4">
                        <h4>âš¡ on_llm_new_token</h4>
                        <p>æ¯ä¸ª token è§¦å‘<br>å®æ—¶ç»Ÿè®¡è®¡æ•°</p>
                    </div>

                    <div class="flow-arrow" id="arrow4">â†’</div>

                    <div class="flow-step" id="step5">
                        <h4>âœ… on_llm_end</h4>
                        <p>è®°å½•ç»“æŸæ—¶é—´<br>è®¡ç®—æ€»è€—æ—¶<br>ç»Ÿè®¡ token æ•°</p>
                    </div>
                </div>

                <!-- å›è°ƒæ—¥å¿—å®æ—¶æ¼”ç¤º -->
                <div class="callback-log-demo" id="callbackLogDemo" style="display: none;">
                    <h3 style="text-align: center; color: #a78bfa; margin-bottom: 20px;">ğŸ“‹ å›è°ƒæ—¥å¿—è¾“å‡ºï¼ˆå®æ—¶ï¼‰</h3>
                    <div id="logContainer"></div>
                </div>
            </div>

            <div class="code-block">
                <pre><code><span class="comment"># å›è°ƒæµç¨‹ç¤ºä¾‹</span>
<span class="keyword">class</span> <span class="function">MyCallbackHandler</span>(BaseCallbackHandler):

    <span class="keyword">def</span> <span class="function">on_llm_start</span>(self, prompts, **kwargs):
        <span class="comment">â‘  æ­¥éª¤ 2: è®°å½•å¼€å§‹</span>
        print(f<span class="string">"å¼€å§‹å¤„ç†: {prompts[0]}"</span>)

    <span class="keyword">def</span> <span class="function">on_llm_new_token</span>(self, token, **kwargs):
        <span class="comment">â‘¡ æ­¥éª¤ 4: å¤„ç†æ¯ä¸ª token</span>
        print(token, end=<span class="string">""</span>, flush=<span class="string">True</span>)

    <span class="keyword">def</span> <span class="function">on_llm_end</span>(self, response, **kwargs):
        <span class="comment">â‘¢ æ­¥éª¤ 5: è®°å½•ç»“æŸ</span>
        print(f<span class="string">"\nå®Œæˆï¼æ€» token æ•°: {token_count}"</span>)

<span class="comment"># ä½¿ç”¨å›è°ƒ</span>
llm.invoke(<span class="string">"è§£é‡Š Python"</span>, callbacks=[MyCallbackHandler()])</code></pre>
            </div>
        </div>

        <!-- åœºæ™¯ 3: æµå¼è¾“å‡º -->
        <div class="scene" id="scene3">
            <h2 class="scene-title">âŒ¨ï¸ æµå¼è¾“å‡ºï¼šæ‰“å­—æœºæ•ˆæœ</h2>

            <div class="highlight-box">
                <h3>ğŸ¯ ä»€ä¹ˆæ˜¯æµå¼è¾“å‡ºï¼Ÿ</h3>
                <p>
                    <strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong>ç­‰å¾…å®Œæ•´å“åº”åä¸€æ¬¡æ€§æ˜¾ç¤ºï¼ˆä½“éªŒå·®ï¼Œç­‰å¾…æ—¶é—´é•¿ï¼‰<br><br>
                    <strong>æµå¼è¾“å‡ºï¼š</strong>é€ä¸ª token å®æ—¶æ˜¾ç¤ºï¼ˆä½“éªŒå¥½ï¼Œå³æ—¶åé¦ˆï¼‰<br><br>
                    <strong>å°±åƒæœ‰äººåœ¨ä½ é¢å‰æ‰“å­—ä¸€æ ·ï¼Œé€å­—é€å¥åœ°ç”Ÿæˆå†…å®¹ï¼</strong>
                </p>
            </div>

            <div class="streaming-demo">
                <h4 style="color: #a78bfa; margin-bottom: 15px; text-align: center;">æµå¼è¾“å‡ºæ¼”ç¤º</h4>
                <div class="streaming-output" id="streamingOutput">
                    <span id="streamingText"></span><span class="cursor"></span>
                </div>
                <div class="streaming-controls">
                    <button class="demo-btn" id="startStreamBtn">â–¶ å¼€å§‹æµå¼è¾“å‡º</button>
                    <button class="demo-btn" id="resetStreamBtn" disabled>â†º é‡ç½®</button>
                </div>
                <div style="margin-top: 20px; text-align: center; color: rgba(226, 232, 240, 0.6);">
                    <p>Token è®¡æ•°: <span id="tokenCount" style="color: #a78bfa; font-weight: bold;">0</span></p>
                </div>
            </div>

            <div class="code-block">
                <pre><code><span class="comment"># æµå¼è¾“å‡ºä»£ç ç¤ºä¾‹</span>
<span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI

llm = ChatOpenAI(model=<span class="string">"gpt-3.5-turbo"</span>)

<span class="comment"># æ–¹æ³• 1: ç›´æ¥ä½¿ç”¨ stream()</span>
<span class="keyword">for</span> chunk <span class="keyword">in</span> llm.stream(<span class="string">"è®²ä¸€ä¸ªå…³äº AI çš„ç¬‘è¯"</span>):
    print(chunk.content, end=<span class="string">""</span>, flush=<span class="string">True</span>)

<span class="comment"># æ–¹æ³• 2: åœ¨é“¾ä¸­ä½¿ç”¨</span>
chain = prompt | llm | StrOutputParser()

<span class="keyword">for</span> chunk <span class="keyword">in</span> chain.stream({<span class="string">"topic"</span>: <span class="string">"é‡å­è®¡ç®—"</span>}):
    print(chunk, end=<span class="string">""</span>, flush=<span class="string">True</span>)</code></pre>
            </div>

            <div class="feature-grid">
                <div class="feature-card" data-delay="0">
                    <div class="feature-icon">âš¡</div>
                    <h4>å³æ—¶åé¦ˆ</h4>
                    <p>ç”¨æˆ·æ— éœ€ç­‰å¾…å®Œæ•´å“åº”ï¼Œç«‹å³çœ‹åˆ°è¾“å‡º</p>
                </div>

                <div class="feature-card" data-delay="100">
                    <div class="feature-icon">ğŸ’¬</div>
                    <h4>èŠå¤©ä½“éªŒ</h4>
                    <p>æ¨¡æ‹ŸçœŸäººå¯¹è¯ï¼Œé€å­—æ˜¾ç¤ºæ›´è‡ªç„¶</p>
                </div>

                <div class="feature-card" data-delay="200">
                    <div class="feature-icon">ğŸ“Š</div>
                    <h4>è¿›åº¦å¯è§</h4>
                    <p>ç”¨æˆ·çŸ¥é“ç³»ç»Ÿæ­£åœ¨å·¥ä½œï¼Œä¸ä¼šç„¦è™‘</p>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯ 4: Token è¿½è¸ª -->
        <div class="scene" id="scene4">
            <h2 class="scene-title">ğŸ”¢ Token è¿½è¸ªä¸æˆæœ¬ç›‘æ§</h2>

            <div class="highlight-box">
                <h3>ğŸ’¡ å®æˆ˜åœºæ™¯ï¼šå®æ—¶è¿½è¸ªLLMè°ƒç”¨æˆæœ¬</h3>
                <p>
                    æ¯æ¬¡APIè°ƒç”¨éƒ½ä¼šäº§ç”Ÿtokenæ¶ˆè€—ã€‚é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
                    <strong style="color: #3b82f6;">å®æ—¶è®¡æ•°</strong>ã€
                    <strong style="color: #fbbf24;">è®¡ç®—æˆæœ¬</strong>ã€
                    <strong style="color: #22c55e;">æ§åˆ¶é¢„ç®—</strong>
                </p>
                <button class="demo-btn" id="startTokenBtn">â–¶ï¸ å¯åŠ¨å®æ—¶è¿½è¸ªæ¼”ç¤º</button>
            </div>

            <div class="canvas-container">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="tracking-stats" id="trackingStats">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“ æç¤ºè¯ Tokens</div>
                        <div class="stat-number" id="promptTokens">0</div>
                        <div class="stat-label">è¾“å…¥æ¶ˆè€—</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">ğŸ’¬ ç”Ÿæˆ Tokens</div>
                        <div class="stat-number" id="completionTokens">0</div>
                        <div class="stat-label">è¾“å‡ºæ¶ˆè€—</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">ğŸ“Š æ€»è®¡ Tokens</div>
                        <div class="stat-number" id="totalTokens">0</div>
                        <div class="stat-label">æ€»é‡</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">ğŸ’° é¢„ä¼°æˆæœ¬</div>
                        <div class="stat-number" id="estimatedCost">$0.000</div>
                        <div class="stat-label">GPT-3.5: $0.0015/1K tokens</div>
                    </div>
                </div>

                <!-- Token æµè¿½è¸ª -->
                <div style="margin-top: 30px;">
                    <h3 style="text-align: center; color: #a78bfa; margin-bottom: 20px;">ğŸ“‹ Token æµå®æ—¶æ—¥å¿—</h3>
                    <div class="token-tracker" id="tokenTracker" style="max-height: 400px; overflow-y: auto;">
                        <!-- Token æ—¥å¿—å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>

            <div class="code-block">
                <pre><code><span class="keyword">class</span> <span class="function">TokenCounterHandler</span>(BaseCallbackHandler):
    <span class="string">"""Token è®¡æ•°å›è°ƒå¤„ç†å™¨"""</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self.token_count = 0
        self.tokens = []

    <span class="keyword">def</span> <span class="function">on_llm_start</span>(self, prompts, **kwargs):
        print(<span class="string">f"å¼€å§‹å¤„ç†æç¤ºè¯..."</span>)

    <span class="keyword">def</span> <span class="function">on_llm_new_token</span>(self, token, **kwargs):
        self.token_count += 1
        self.tokens.append(token)
        print(<span class="string">f"Token #{self.token_count}: {token}"</span>)

    <span class="keyword">def</span> <span class="function">on_llm_end</span>(self, response, **kwargs):
        print(<span class="string">f"\næ€»è®¡ç”Ÿæˆ {self.token_count} ä¸ª tokens"</span>)
        print(<span class="string">f"å®Œæ•´æ–‡æœ¬: {''.join(self.tokens)}"</span>)

<span class="comment"># ä½¿ç”¨</span>
handler = TokenCounterHandler()
llm.invoke(<span class="string">"å†™ä¸€ä¸ªçŸ­æ•…äº‹"</span>, callbacks=[handler])</code></pre>
            </div>
        </div>

        <!-- åœºæ™¯ 5: è‡ªå®šä¹‰å›è°ƒ -->
        <div class="scene" id="scene5">
            <h2 class="scene-title">ğŸ› ï¸ è‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨</h2>

            <div class="highlight-box">
                <h3>ğŸ’¡ ä»€ä¹ˆæ˜¯"è‡ªå®šä¹‰"å›è°ƒï¼Ÿ</h3>
                <p>
                    <strong style="color: #3b82f6;">å†…ç½®å›è°ƒ</strong> = LangChain è‡ªå¸¦çš„ï¼ŒåŠŸèƒ½å›ºå®šï¼ˆåªèƒ½æ‰“å°åˆ°æ§åˆ¶å°ï¼‰<br>
                    <strong style="color: #22c55e;">è‡ªå®šä¹‰å›è°ƒ</strong> = ä½ è‡ªå·±ç¼–å†™çš„ï¼Œæ»¡è¶³ä½ çš„ç‰¹æ®Šéœ€æ±‚
                </p>
                <p style="margin-top: 15px;">
                    <strong>ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ï¼Ÿ</strong><br>
                    â€¢ å†…ç½®çš„åªèƒ½æ‰“å°ï¼Œä½ æƒ³<strong>ä¿å­˜åˆ°æ•°æ®åº“</strong>ï¼Ÿ<br>
                    â€¢ å†…ç½®çš„ä¸æ”¯æŒè®¡è´¹ï¼Œä½ æƒ³<strong>è¿½è¸ªæˆæœ¬</strong>ï¼Ÿ<br>
                    â€¢ å†…ç½®çš„ä¸å‘å‘Šè­¦ï¼Œä½ æƒ³<strong>é”™è¯¯æ—¶é€šçŸ¥ä½ </strong>ï¼Ÿ<br>
                    â†’ è¿™å°±éœ€è¦<strong>è‡ªå·±å†™</strong>å›è°ƒå¤„ç†å™¨ï¼
                </p>
            </div>

            <!-- å¯¹æ¯”æ¼”ç¤º -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                <!-- å†…ç½®å›è°ƒ -->
                <div class="comparison-card" style="border-left: 4px solid #64748b;">
                    <h4 style="color: #94a3b8; margin-bottom: 15px;">âŒ å†…ç½®å›è°ƒï¼ˆåŠŸèƒ½æœ‰é™ï¼‰</h4>
                    <div class="code-block" style="font-size: 0.9em;">
                        <pre><code><span style="color: #94a3b8;"># ä½¿ç”¨ LangChain è‡ªå¸¦çš„</span>
<span class="keyword">from</span> langchain.callbacks <span class="keyword">import</span> StdOutCallbackHandler

<span style="color: #94a3b8;"># åªèƒ½æ‰“å°åˆ°æ§åˆ¶å°</span>
handler = StdOutCallbackHandler()

llm.invoke(<span class="string">"ä½ å¥½"</span>, callbacks=[handler])

<span style="color: #94a3b8;"># è¾“å‡ºï¼š</span>
<span style="color: #94a3b8;"># ä½ å¥½</span></code></pre>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(100, 116, 139, 0.1); border-radius: 8px;">
                        <strong style="color: #ef4444;">âš ï¸ é™åˆ¶ï¼š</strong><br>
                        â€¢ åªèƒ½æ‰“å°åˆ°å±å¹•<br>
                        â€¢ ä¸èƒ½ä¿å­˜åˆ°æ–‡ä»¶<br>
                        â€¢ ä¸èƒ½å‘é€é€šçŸ¥<br>
                        â€¢ ä¸èƒ½è‡ªå®šä¹‰é€»è¾‘
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰å›è°ƒ -->
                <div class="comparison-card" style="border-left: 4px solid #22c55e;">
                    <h4 style="color: #4ade80; margin-bottom: 15px;">âœ… è‡ªå®šä¹‰å›è°ƒï¼ˆåŠŸèƒ½å¼ºå¤§ï¼‰</h4>
                    <div class="code-block" style="font-size: 0.9em;">
                        <pre><code><span style="color: #4ade80;"># ä½ è‡ªå·±ç¼–å†™çš„</span>
<span class="keyword">class</span> <span class="function">MyCustomHandler</span>(BaseCallbackHandler):
    <span class="keyword">def</span> <span class="function">on_llm_end</span>(self, response, **kwargs):
        <span style="color: #4ade80;"># ä½ çš„è‡ªå®šä¹‰é€»è¾‘</span>
        save_to_database(response)  <span style="color: #4ade80;"># â† ä¿å­˜æ•°æ®åº“</span>
        send_to_slack(response)       <span style="color: #4ade80;"># â† å‘é€ Slack</span>
        calculate_cost(response)     <span style="color: #4ade80;"># â† è®¡ç®—æˆæœ¬</span>

handler = MyCustomHandler()
llm.invoke(<span class="string">"ä½ å¥½"</span>, callbacks=[handler])</code></pre>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <strong style="color: #22c55e;">âœ¨ ä¼˜åŠ¿ï¼š</strong><br>
                        â€¢ å®Œå…¨è‡ªå®šä¹‰é€»è¾‘<br>
                        â€¢ ä¿å­˜åˆ°ä»»ä½•åœ°æ–¹<br>
                        â€¢ å‘é€é€šçŸ¥/å‘Šè­¦<br>
                        â€¢ å®ç°ä¸šåŠ¡éœ€æ±‚
                    </div>
                </div>
            </div>

            <!-- å®é™…ç¤ºä¾‹ -->
            <h3 style="text-align: center; color: #a78bfa; margin: 40px 0 20px;">ğŸ“‹ è‡ªå®šä¹‰å›è°ƒç¤ºä¾‹ï¼šæˆæœ¬è¿½è¸ªå™¨</h3>

            <div class="code-block">
                <pre><code><span class="keyword">from</span> langchain_core.callbacks <span class="keyword">import</span> BaseCallbackHandler
<span class="keyword">from</span> typing <span class="keyword">import</span> Any, Dict, List
<span class="keyword">import</span> json
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime

<span class="keyword">class</span> <span class="function">CostTrackerHandler</span>(BaseCallbackHandler):
    <span class="string">"""
    ğŸ¯ è‡ªå®šä¹‰å›è°ƒï¼šè¿½è¸ªæ¯æ¬¡ LLM è°ƒç”¨çš„æˆæœ¬

    è¿™æ˜¯æˆ‘è‡ªå·±å†™çš„ï¼ä¸æ˜¯ LangChain è‡ªå¸¦çš„ï¼
    """</span>

    <span class="comment"># å®šä¹‰ä»·æ ¼ï¼ˆå¯ä»¥éšæ—¶ä¿®æ”¹ï¼‰</span>
    PRICING = {
        <span class="string">"gpt-3.5-turbo"</span>: {<span class="string">"input"</span>: 0.0005, <span class="string">"output"</span>: 0.0015},
        <span class="string">"gpt-4"</span>: {<span class="string">"input"</span>: 0.03, <span class="string">"output"</span>: 0.06}
    }

    <span class="keyword">def</span> <span class="function">__init__</span>(self, user_id: str):
        <span class="comment"># åˆå§‹åŒ–ï¼šè®°å½•ç”¨æˆ· ID</span>
        self.user_id = user_id
        self.total_cost = 0.0

    <span class="keyword">def</span> <span class="function">on_llm_start</span>(self, prompts: List[str], **kwargs):
        <span class="comment"># LLM å¼€å§‹æ—¶ï¼šè®°å½•å¼€å§‹æ—¶é—´</span>
        self.start_time = datetime.now()
        print(f<span class="string">"ğŸŸ¢ ç”¨æˆ· {self.user_id} å¼€å§‹è°ƒç”¨ LLM..."</span>)

    <span class="keyword">def</span> <span class="function">on_llm_new_token</span>(self, token: str, **kwargs):
        <span class="comment"># æ¯ä¸ª tokenï¼šå®æ—¶æ˜¾ç¤ºè¿›åº¦</span>
        print(token, end=<span class="string">""</span>, flush=<span class="string">True</span>)

    <span class="keyword">def</span> <span class="function">on_llm_end</span>(self, response, **kwargs):
        <span class="comment"># LLM ç»“æŸæ—¶ï¼šè®¡ç®—æˆæœ¬</span>
        usage = response.llm_output.get(<span class="string">'token_usage'</span>, {})
        input_tokens = usage.get(<span class="string">'prompt_tokens'</span>, 0)
        output_tokens = usage.get(<span class="string">'completion_tokens'</span>, 0)

        <span class="comment"># è®¡ç®—æˆæœ¬</span>
        pricing = self.PRICING[<span class="string">"gpt-3.5-turbo"</span>]
        cost = (input_tokens / 1000 * pricing[<span class="string">'input'</span>] +
                output_tokens / 1000 * pricing[<span class="string">'output'</span>])

        self.total_cost += cost

        <span class="comment"># ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè‡ªå®šä¹‰é€»è¾‘ï¼ï¼‰</span>
        log_entry = {
            <span class="string">"user_id"</span>: self.user_id,
            <span class="string">"timestamp"</span>: datetime.now().isoformat(),
            <span class="string">"tokens"</span>: input_tokens + output_tokens,
            <span class="string">"cost"</span>: cost
        }
        <span class="keyword">with</span> open(<span class="string">"cost_log.json"</span>, <span class="string">"a"</span>) <span class="keyword">as</span> f:
            f.write(json.dumps(log_entry) + <span class="string">"\n"</span>)

        <span class="comment"># æ‰“å°ç»Ÿè®¡</span>
        print(f<span class="string">"\nâœ… å®Œæˆï¼æˆæœ¬: ${cost:.6f}"</span>)
        print(f<span class="string">"ğŸ’° æ€»æˆæœ¬: ${self.total_cost:.6f}"</span>)

<span class="comment"># ========== ä½¿ç”¨ ==========</span>
<span class="comment"># åˆ›å»ºè‡ªå®šä¹‰å›è°ƒå®ä¾‹</span>
my_handler = CostTrackerHandler(user_id=<span class="string">"user_123"</span>)

<span class="comment"># ä¼ é€’ç»™ LLM</span>
response = llm.invoke(<span class="string">"è®²ä¸€ä¸ªç¬‘è¯"</span>, callbacks=[my_handler])

<span class="comment"># è¾“å‡ºï¼š</span>
<span class="comment"># ğŸŸ¢ ç”¨æˆ· user_123 å¼€å§‹è°ƒç”¨ LLM...</span>
<span class="comment"># ä¸ºä»€ä¹ˆç¨‹åºå‘˜å–œæ¬¢é»‘æš—æ¨¡å¼ï¼Ÿ</span>
<span class="comment"># å› ä¸ºå…‰å¸å¼•è™«å­ï¼</span>
<span class="comment"># </span>
<span class="comment"># âœ… å®Œæˆï¼æˆæœ¬: $0.000450</span>
<span class="comment"># ğŸ’° æ€»æˆæœ¬: $0.000450</span></code></pre>
            </div>

            <div class="highlight-box" style="margin-top: 30px;">
                <h3>ğŸ¯ å…³é”®ç†è§£</h3>
                <p>
                    <strong>è‡ªå®šä¹‰ = ç»§æ‰¿ BaseCallbackHandler + é‡å†™æ–¹æ³•</strong><br><br>
                    1ï¸âƒ£ <strong>ç»§æ‰¿</strong>: `class MyHandler(BaseCallbackHandler)`<br>
                    2ï¸âƒ£ <strong>é‡å†™</strong>: å®ç°ä½ éœ€è¦çš„å›è°ƒæ–¹æ³•ï¼ˆå¦‚ `on_llm_end`ï¼‰<br>
                    3ï¸âƒ£ <strong>é€»è¾‘</strong>: åœ¨æ–¹æ³•é‡Œå†™ä½ çš„ä»£ç ï¼ˆä¿å­˜æ•°æ®ã€å‘é€é€šçŸ¥ç­‰ï¼‰<br>
                    4ï¸âƒ£ <strong>ä½¿ç”¨</strong>: `llm.invoke(..., callbacks=[MyHandler()])`<br><br>
                    <strong style="color: #fbbf24;">å°±è¿™ä¹ˆç®€å•ï¼ä½ å®Œå…¨æŒæ§å›è°ƒçš„è¡Œä¸ºï¼</strong>
                </p>
            </div>

            <div class="callback-events" style="margin-top: 30px;">
                <h3 style="text-align: center; color: #a78bfa; margin-bottom: 20px;">ğŸ“‹ å¯ç”¨çš„å›è°ƒæ–¹æ³•ï¼ˆä½ å¯ä»¥é‡å†™è¿™äº›ï¼‰</h3>

                <div class="event-card" data-delay="0">
                    <h4>ğŸ¯ on_llm_start</h4>
                    <p>LLM å¼€å§‹è°ƒç”¨æ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>è®°å½•æ—¥å¿—ã€å¼€å§‹è®¡æ—¶ã€åˆå§‹åŒ–å˜é‡</p>
                </div>

                <div class="event-card" data-delay="100">
                    <h4>âš¡ on_llm_new_token</h4>
                    <p>æ¯ä¸ªæ–° token ç”Ÿæˆæ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>å®æ—¶æ˜¾ç¤ºã€ç»Ÿè®¡è®¡æ•°ã€æµå¼å¤„ç†</p>
                </div>

                <div class="event-card" data-delay="200">
                    <h4>âœ… on_llm_end</h4>
                    <p>LLM è°ƒç”¨ç»“æŸæ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>ä¿å­˜ç»“æœã€è®¡ç®—æˆæœ¬ã€å†™å…¥æ•°æ®åº“</p>
                </div>

                <div class="event-card" data-delay="300">
                    <h4>âŒ on_llm_error</h4>
                    <p>å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>é”™è¯¯å¤„ç†ã€å‘é€å‘Šè­¦ã€è®°å½•æ—¥å¿—</p>
                </div>

                <div class="event-card" data-delay="400">
                    <h4>ğŸ”— on_chain_start</h4>
                    <p>é“¾å¼€å§‹æ‰§è¡Œæ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>è¿½è¸ªé“¾çš„æ‰§è¡Œæµç¨‹</p>
                </div>

                <div class="event-card" data-delay="500">
                    <h4>ğŸ”— on_chain_end</h4>
                    <p>é“¾æ‰§è¡Œç»“æŸæ—¶è§¦å‘<br><strong>ä½ å¯ä»¥ï¼š</strong>è®°å½•é“¾çš„è¾“å‡ºã€æ€§èƒ½åˆ†æ</p>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯ 6: å®é™…åº”ç”¨ -->
        <div class="scene" id="scene6">
            <h2 class="scene-title">ğŸš€ å®é™…åº”ç”¨åœºæ™¯</h2>

            <div class="use-case-container">
                <div class="use-case" data-delay="0">
                    <h4>ğŸ’¬ èŠå¤©åº”ç”¨</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>ChatGPT é£æ ¼çš„å¯¹è¯ç•Œé¢<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ ä½¿ç”¨ on_llm_new_token å®æ—¶æ˜¾ç¤ºå“åº”<br>
                        â€¢ æµå¼è¾“å‡ºè®©å¯¹è¯æ›´è‡ªç„¶<br>
                        â€¢ Token è¿½è¸ªæ§åˆ¶æˆæœ¬<br><br>
                        <strong>æ•ˆæœï¼š</strong>ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ï¼
                    </p>
                </div>

                <div class="use-case" data-delay="200">
                    <h4>ğŸ“Š æ—¥å¿—ç³»ç»Ÿ</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>ç”Ÿäº§ç¯å¢ƒç›‘æ§å’Œè°ƒè¯•<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ on_llm_start è®°å½•è¯·æ±‚ä¿¡æ¯<br>
                        â€¢ on_llm_end è®°å½•å“åº”å’Œè€—æ—¶<br>
                        â€¢ on_llm_error è®°å½•é”™è¯¯è¯¦æƒ…<br><br>
                        <strong>æ•ˆæœï¼š</strong>å®Œæ•´è°ƒç”¨é“¾è¿½è¸ªï¼
                    </p>
                </div>

                <div class="use-case" data-delay="400">
                    <h4>ğŸ’° æˆæœ¬ç®¡ç†</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>å¤šç”¨æˆ· API æˆæœ¬åˆ†æ‘Š<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„æˆæœ¬è¿½è¸ªå™¨<br>
                        â€¢ å®æ—¶ç»Ÿè®¡ token ä½¿ç”¨é‡<br>
                        â€¢ è®¾ç½®é¢„ç®—é™åˆ¶å’Œå‘Šè­¦<br><br>
                        <strong>æ•ˆæœï¼š</strong>æˆæœ¬å¯æ§ï¼Œé€æ˜è®¡è´¹ï¼
                    </p>
                </div>

                <div class="use-case" data-delay="600">
                    <h4>ğŸ¯ æ€§èƒ½ä¼˜åŒ–</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>åˆ†æ LLM åº”ç”¨æ€§èƒ½ç“¶é¢ˆ<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ TimingHandler æµ‹é‡å“åº”æ—¶é—´<br>
                        â€¢ TokenCounter åˆ†æè¾“å‡ºé•¿åº¦<br>
                        â€¢ è¯†åˆ«æ…¢æŸ¥è¯¢å’Œä¼˜åŒ–ç‚¹<br><br>
                        <strong>æ•ˆæœï¼š</strong>æ€§èƒ½æå‡ 50%ï¼
                    </p>
                </div>

                <div class="use-case" data-delay="800">
                    <h4>ğŸ”’ å†…å®¹å®¡æ ¸</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>å®æ—¶å†…å®¹å®‰å…¨æ£€æŸ¥<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ on_llm_new_token é€ token æ£€æŸ¥<br>
                        â€¢ å‘ç°æ•æ„Ÿå†…å®¹ç«‹å³ä¸­æ–­<br>
                        â€¢ è®°å½•è¿è§„æ—¥å¿—<br><br>
                        <strong>æ•ˆæœï¼š</strong>å®æ—¶é˜²æŠ¤ï¼Œå®‰å…¨å¯æ§ï¼
                    </p>
                </div>

                <div class="use-case" data-delay="1000">
                    <h4>ğŸ“ˆ æ•°æ®åˆ†æ</h4>
                    <p>
                        <strong>åœºæ™¯ï¼š</strong>äº†è§£ç”¨æˆ·ä½¿ç”¨æ¨¡å¼<br><br>
                        <strong>å®ç°ï¼š</strong><br>
                        â€¢ ç»Ÿè®¡é«˜é¢‘æŸ¥è¯¢ç±»å‹<br>
                        â€¢ åˆ†æå¹³å‡å“åº”é•¿åº¦<br>
                        â€¢ è¿½è¸ªç”¨æˆ·æ»¡æ„åº¦<br><br>
                        <strong>æ•ˆæœï¼š</strong>æ•°æ®é©±åŠ¨å†³ç­–ï¼
                    </p>
                </div>
            </div>

            <div class="highlight-box" style="background: rgba(34, 197, 94, 0.15); border-left-color: #22c55e;">
                <h3 style="color: #22c55e;">ğŸ¯ æœ€ä½³å®è·µæ€»ç»“</h3>
                <p>
                    <strong>å¼€å‘ç¯å¢ƒï¼š</strong>StdOutCallbackHandler + TokenCounter + TimingHandler<br>
                    <strong>ç”Ÿäº§ç¯å¢ƒï¼š</strong>LoggingHandler + CostTracker + ErrorHandler<br>
                    <strong>è°ƒè¯•æ¨¡å¼ï¼š</strong>DetailedLogger + TokenCounter<br>
                    <strong>èŠå¤©åº”ç”¨ï¼š</strong>StreamingHandler + UIUpdateHandler<br><br>
                    <strong>è®°ä½ï¼š</strong>å›è°ƒæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„ç»ä½³åº”ç”¨ï¼Œè®©ä½ çš„ LLM åº”ç”¨æ›´åŠ æ™ºèƒ½å’Œå¯æ§ï¼
                </p>
            </div>

            <div class="code-block">
                <pre><code><span class="comment"># ç»„åˆå¤šä¸ªå›è°ƒ</span>
<span class="keyword">from</span> langchain.callbacks <span class="keyword">import</span> StdOutCallbackHandler

token_counter = TokenCounterHandler()
timer = TimingHandler()
logger = StdOutCallbackHandler()

response = llm.invoke(
    <span class="string">"è®²ä¸€ä¸ªæœ‰è¶£çš„æ•…äº‹"</span>,
    callbacks=[token_counter, timer, logger]
)

<span class="comment"># è¾“å‡ºï¼š</span>
<span class="comment"># [Timer] å¼€å§‹æ—¶é—´: 14:30:25</span>
<span class="comment"># [TokenCounter] LLM å¼€å§‹å¤„ç†...</span>
<span class="comment"># Token #1: ä»</span>
<span class="comment"># Token #2: å‰</span>
<span class="comment"># ...</span>
<span class="comment"># [Timer] ç»“æŸæ—¶é—´: 14:30:27</span>
<span class="comment"># [Timer] æ€»è€—æ—¶: 2.35 ç§’</span>
<span class="comment"># [TokenCounter] æ€» token æ•°: 156</span></code></pre>
            </div>
        </div>

        <!-- åœºæ™¯æŒ‡ç¤ºå™¨ -->
        <div class="scene-indicators">
            <div class="indicator active" data-scene="1"></div>
            <div class="indicator" data-scene="2"></div>
            <div class="indicator" data-scene="3"></div>
            <div class="indicator" data-scene="4"></div>
            <div class="indicator" data-scene="5"></div>
            <div class="indicator" data-scene="6"></div>
        </div>

        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="nav-buttons">
            <button class="nav-btn" id="prevBtn" disabled>
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                ä¸Šä¸€èŠ‚
            </button>
            <a href="index.html" class="nav-btn back-to-list">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
                è¯¾ç¨‹åˆ—è¡¨
            </a>
            <button class="nav-btn next" id="nextBtn">
                ä¸‹ä¸€èŠ‚
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // åœºæ™¯æ•°æ®
        const totalScenes = 6;
        let currentScene = 1;

        // DOM å…ƒç´ 
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const indicators = document.querySelectorAll('.indicator');

        // æµå¼è¾“å‡ºæ–‡æœ¬
        const streamingTextSample = "Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œä»¥å…¶ç®€æ´æ˜äº†çš„è¯­æ³•è€Œé—»åã€‚å®ƒæ”¯æŒå¤šç§ç¼–ç¨‹èŒƒå¼ï¼ŒåŒ…æ‹¬é¢å‘å¯¹è±¡ã€å‡½æ•°å¼å’Œè¿‡ç¨‹å¼ç¼–ç¨‹ã€‚Python æ‹¥æœ‰ä¸°å¯Œçš„æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ï¼Œå¹¿æ³›åº”ç”¨äº Web å¼€å‘ã€æ•°æ®åˆ†æã€äººå·¥æ™ºèƒ½ç­‰é¢†åŸŸã€‚";

        // Token è¿½è¸ªç¤ºä¾‹
        const tokenSample = [
            "ä»å‰", "æœ‰", "ä¸€åª", "ä¼š", "è¯´è¯", "çš„", "çŒ«",
            "å®ƒ", "å–œæ¬¢", "åœ¨", "æœˆå…‰", "ä¸‹", "æ€è€ƒ",
            "äººç”Ÿ", "çš„", "æ„ä¹‰", "..."
        ];

        // åˆå§‹åŒ–
        function init() {
            updateScene();
            setupEventListeners();
            animateSceneElements();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // å¯¼èˆªæŒ‰é’®
            prevBtn.addEventListener('click', () => {
                if (currentScene > 1) {
                    currentScene--;
                    updateScene();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentScene < totalScenes) {
                    currentScene++;
                    updateScene();
                }
            });

            // æŒ‡ç¤ºå™¨
            indicators.forEach(indicator => {
                indicator.addEventListener('click', () => {
                    currentScene = parseInt(indicator.dataset.scene);
                    updateScene();
                });
            });

            // é”®ç›˜å¯¼èˆª
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight' && currentScene < totalScenes) {
                    currentScene++;
                    updateScene();
                } else if (e.key === 'ArrowLeft' && currentScene > 1) {
                    currentScene--;
                    updateScene();
                }
            });

            // åœºæ™¯ 2: æµç¨‹æ¼”ç¤º
            const startFlowBtn = document.getElementById('startFlowBtn');
            if (startFlowBtn) {
                startFlowBtn.addEventListener('click', animateFlowProcess);
            }

            // åœºæ™¯ 3: æµå¼è¾“å‡º
            const startStreamBtn = document.getElementById('startStreamBtn');
            const resetStreamBtn = document.getElementById('resetStreamBtn');
            if (startStreamBtn) {
                startStreamBtn.addEventListener('click', startStreaming);
            }
            if (resetStreamBtn) {
                resetStreamBtn.addEventListener('click', resetStreaming);
            }

            // åœºæ™¯ 4: Token è¿½è¸ª
            const startTokenBtn = document.getElementById('startTokenBtn');
            if (startTokenBtn) {
                startTokenBtn.addEventListener('click', animateTokenTracking);
            }
        }

        // æ›´æ–°åœºæ™¯
        function updateScene() {
            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentScene - 1) / (totalScenes - 1)) * 100;
            progressBar.style.width = progress + '%';

            // æ›´æ–°åœºæ™¯æ˜¾ç¤º
            document.querySelectorAll('.scene').forEach((scene, index) => {
                if (index + 1 === currentScene) {
                    scene.classList.add('active');
                } else {
                    scene.classList.remove('active');
                }
            });

            // æ›´æ–°æŒ‡ç¤ºå™¨
            indicators.forEach((indicator, index) => {
                if (index + 1 === currentScene) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = currentScene === 1;
            nextBtn.disabled = currentScene === totalScenes;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // åŠ¨ç”»æ˜¾ç¤ºå…ƒç´ 
            setTimeout(() => {
                animateSceneElements();
            }, 300);
        }

        // åŠ¨ç”»æ˜¾ç¤ºåœºæ™¯å…ƒç´ 
        function animateSceneElements() {
            const currentSceneEl = document.querySelector(`#scene${currentScene}`);

            // æµç¨‹æ­¥éª¤åŠ¨ç”»
            currentSceneEl.querySelectorAll('.flow-step').forEach((step, index) => {
                const delay = parseInt(step.dataset.delay) || index * 200;
                setTimeout(() => {
                    step.classList.add('visible');
                }, delay);
            });

            // æµç¨‹ç®­å¤´åŠ¨ç”»
            currentSceneEl.querySelectorAll('.flow-arrow').forEach((arrow, index) => {
                const delay = parseInt(arrow.dataset.delay) || index * 200;
                setTimeout(() => {
                    arrow.classList.add('visible');
                }, delay);
            });

            // ç‰¹æ€§å¡ç‰‡åŠ¨ç”»
            currentSceneEl.querySelectorAll('.feature-card').forEach((card, index) => {
                const delay = parseInt(card.dataset.delay) || index * 100;
                setTimeout(() => {
                    card.classList.add('visible');
                }, delay);
            });

            // äº‹ä»¶å¡ç‰‡åŠ¨ç”»
            currentSceneEl.querySelectorAll('.event-card').forEach((card, index) => {
                const delay = parseInt(card.dataset.delay) || index * 100;
                setTimeout(() => {
                    card.classList.add('visible');
                }, delay);
            });

            // åº”ç”¨åœºæ™¯åŠ¨ç”»
            currentSceneEl.querySelectorAll('.use-case').forEach((useCase, index) => {
                const delay = parseInt(useCase.dataset.delay) || index * 200;
                setTimeout(() => {
                    useCase.classList.add('visible');
                }, delay);
            });
        }

        // åœºæ™¯ 2: æµç¨‹æ¼”ç¤ºåŠ¨ç”» - å¸¦çœŸå®æ—¥å¿—
        async function animateFlowProcess() {
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
            const arrows = ['arrow1', 'arrow2', 'arrow3', 'arrow4'];

            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            steps.forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('active-step', 'visible');
            });
            arrows.forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('visible');
            });

            const startFlowBtn = document.getElementById('startFlowBtn');
            startFlowBtn.disabled = true;
            startFlowBtn.textContent = 'â³ æ¼”ç¤ºä¸­...';

            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            const logDemo = document.getElementById('callbackLogDemo');
            const logContainer = document.getElementById('logContainer');
            logDemo.style.display = 'block';
            logContainer.innerHTML = '';

            // æ¨¡æ‹Ÿçš„LLMå“åº”æ–‡æœ¬
            const responseText = "Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€";
            const tokens = responseText.split('');

            // è·å–å½“å‰æ—¶é—´æˆ³
            const getTimestamp = () => {
                const now = new Date();
                return now.toTimeString().split(' ')[0] + '.' + String(now.getMilliseconds()).padStart(3, '0');
            };

            // æ·»åŠ æ—¥å¿—æ¡ç›®çš„è¾…åŠ©å‡½æ•°
            const addLogEntry = (type, event, details, tokenBadges = []) => {
                return new Promise(resolve => {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${type}`;

                    let tokenHTML = '';
                    if (tokenBadges.length > 0) {
                        tokenHTML = '<div class="token-stream">';
                        tokenBadges.forEach(t => {
                            tokenHTML += `<span class="token-badge">${t}</span>`;
                        });
                        tokenHTML += '</div>';
                    }

                    entry.innerHTML = `
                        <div class="log-timestamp">[${getTimestamp()}]</div>
                        <div class="log-event">${event}</div>
                        <div class="log-details">${details}</div>
                        ${tokenHTML}
                    `;

                    logContainer.appendChild(entry);

                    // è§¦å‘åŠ¨ç”»
                    setTimeout(() => {
                        entry.classList.add('visible');
                        logDemo.scrollTop = logDemo.scrollHeight;
                        resolve();
                    }, 100);
                });
            };

            // æ­¥éª¤1: ç”¨æˆ·è¯·æ±‚
            await new Promise(resolve => setTimeout(resolve, 500));
            document.getElementById('step1').classList.add('visible', 'active-step');
            document.getElementById('arrow1').classList.add('visible');
            await addLogEntry(
                'start',
                'ğŸ“¤ USER INPUT',
                'ç”¨æˆ·è¾“å…¥: "è§£é‡Šä»€ä¹ˆæ˜¯ Python"'
            );

            // æ­¥éª¤2: on_llm_start
            await new Promise(resolve => setTimeout(resolve, 1500));
            document.getElementById('step2').classList.add('visible', 'active-step');
            document.getElementById('arrow2').classList.add('visible');
            await addLogEntry(
                'start',
                'ğŸ”µ on_llm_start',
                `äº‹ä»¶è§¦å‘: LLM å¼€å§‹å¤„ç†<br>ä¼ å…¥å‚æ•°: prompts=["è§£é‡Šä»€ä¹ˆæ˜¯ Python"]<br>æ¨¡å‹: gpt-3.5-turbo<br>æ¸©åº¦: 0.7`
            );

            // æ­¥éª¤3: LLMå¤„ç†ä¸­
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('step3').classList.add('visible', 'active-step');
            document.getElementById('arrow3').classList.add('visible');
            await addLogEntry(
                'start',
                'ğŸ¤– LLM PROCESSING',
                'æ¨¡å‹æ­£åœ¨ç”Ÿæˆå“åº”...<br>ç­‰å¾… tokens æµå¼è¿”å›'
            );

            // æ­¥éª¤4: on_llm_new_token - é€ä¸ªtokenæ¼”ç¤º
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('step4').classList.add('visible', 'active-step');
            document.getElementById('arrow4').classList.add('visible');

            // æ¨¡æ‹Ÿtokenæµ
            let accumulatedTokens = [];
            for (let i = 0; i < tokens.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 200));
                accumulatedTokens.push(tokens[i]);
                await addLogEntry(
                    'token',
                    'ğŸŸ¡ on_llm_new_token',
                    `æ–° token åˆ°è¾¾ (ç¬¬ ${i + 1}/${tokens.length} ä¸ª)<br>ç´¯è®¡ tokens: ${accumulatedTokens.length}`,
                    [tokens[i]]
                );
            }

            // æ­¥éª¤5: on_llm_end
            await new Promise(resolve => setTimeout(resolve, 1500));
            document.getElementById('step5').classList.add('visible', 'active-step');
            await addLogEntry(
                'end',
                'ğŸŸ¢ on_llm_end',
                `LLM å¤„ç†å®Œæˆï¼<br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>æ€»ç”Ÿæˆ tokens: ${tokens.length}<br>å®Œæ•´å“åº”: "${responseText}"<br>çŠ¶æ€: æˆåŠŸ<br>è€—æ—¶: ~${(tokens.length * 0.2).toFixed(1)}ç§’ (æ¨¡æ‹Ÿ)`
            );

            // æœ€ç»ˆæ€»ç»“
            await new Promise(resolve => setTimeout(resolve, 1000));
            const summaryEntry = document.createElement('div');
            summaryEntry.className = 'log-entry end';
            summaryEntry.style.background = 'rgba(34, 197, 94, 0.15)';
            summaryEntry.innerHTML = `
                <div class="log-timestamp">[${getTimestamp()}]</div>
                <div class="log-event">ğŸ“Š å›è°ƒæ‰§è¡Œæ€»ç»“</div>
                <div class="log-details">
                    <strong>å›è°ƒæµç¨‹å®Œæˆï¼</strong><br>
                    â€¢ on_llm_start è§¦å‘: 1 æ¬¡<br>
                    â€¢ on_llm_new_token è§¦å‘: ${tokens.length} æ¬¡<br>
                    â€¢ on_llm_end è§¦å‘: 1 æ¬¡<br>
                    â€¢ æ€»è®¡å›è°ƒäº‹ä»¶: ${tokens.length + 2} æ¬¡<br><br>
                    <strong style="color: #4ade80;">âœ“ é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œæˆ‘ä»¬å®æ—¶è¿½è¸ªäº†æ•´ä¸ªLLMè°ƒç”¨è¿‡ç¨‹ï¼</strong>
                </div>
            `;
            logContainer.appendChild(summaryEntry);
            setTimeout(() => {
                summaryEntry.classList.add('visible');
                logDemo.scrollTop = logDemo.scrollHeight;
            }, 100);

            // æ¢å¤æŒ‰é’®
            await new Promise(resolve => setTimeout(resolve, 2000));
            startFlowBtn.disabled = false;
            startFlowBtn.textContent = 'ğŸ”„ é‡æ–°æ’­æ”¾';
        }

        // åœºæ™¯ 3: æµå¼è¾“å‡ºåŠ¨ç”»
        let streamingInterval;
        let charIndex = 0;
        let tokenCount = 0;

        function startStreaming() {
            const outputEl = document.getElementById('streamingText');
            const countEl = document.getElementById('tokenCount');
            const startBtn = document.getElementById('startStreamBtn');
            const resetBtn = document.getElementById('resetStreamBtn');

            startBtn.disabled = true;
            resetBtn.disabled = true;
            outputEl.textContent = '';
            charIndex = 0;
            tokenCount = 0;
            countEl.textContent = '0';

            streamingInterval = setInterval(() => {
                if (charIndex < streamingTextSample.length) {
                    // æ¨¡æ‹Ÿ token è¾¹ç•Œï¼ˆæŒ‰ä¸­æ–‡åˆ†è¯ï¼‰
                    if (charIndex % 3 === 0) {
                        tokenCount++;
                        countEl.textContent = tokenCount;
                    }

                    outputEl.textContent += streamingTextSample[charIndex];
                    charIndex++;
                } else {
                    clearInterval(streamingInterval);
                    resetBtn.disabled = false;
                }
            }, 50); // æ¯ 50ms ä¸€ä¸ªå­—ç¬¦
        }

        function resetStreaming() {
            clearInterval(streamingInterval);
            document.getElementById('streamingText').textContent = '';
            document.getElementById('tokenCount').textContent = '0';
            document.getElementById('startStreamBtn').disabled = false;
            document.getElementById('resetStreamBtn').disabled = true;
        }

        // åœºæ™¯ 4: Token è¿½è¸ªåŠ¨ç”» - å®æ—¶æˆæœ¬ç›‘æ§
        async function animateTokenTracking() {
            const tracker = document.getElementById('tokenTracker');
            const startBtn = document.getElementById('startTokenBtn');
            const promptEl = document.getElementById('promptTokens');
            const completionEl = document.getElementById('completionTokens');
            const totalEl = document.getElementById('totalTokens');
            const costEl = document.getElementById('estimatedCost');

            // é‡ç½®çŠ¶æ€
            tracker.innerHTML = '';
            startBtn.disabled = true;
            startBtn.textContent = 'â³ è¿½è¸ªä¸­...';
            promptEl.textContent = '0';
            completionEl.textContent = '0';
            totalEl.textContent = '0';
            costEl.textContent = '$0.000';

            // æ¨¡æ‹Ÿçš„æç¤ºè¯å’Œå“åº”
            const prompt = "è¯·ç”¨3å¥è¯è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ";
            const promptTokens = prompt.length; // ç®€åŒ–è®¡ç®—
            const response = "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ã€‚å®ƒé€šè¿‡ç®—æ³•è®©è®¡ç®—æœºä»æ•°æ®ä¸­å­¦ä¹ è§„å¾‹ã€‚åº”ç”¨å¹¿æ³›äºå›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰é¢†åŸŸã€‚";
            const responseTokens = response.split('').length; // ç®€åŒ–è®¡ç®—ï¼Œæ¯ä¸ªå­—ç¬¦ç®—ä¸€ä¸ªtoken

            // GPT-3.5 ä»·æ ¼ (ç¾å…ƒ/1K tokens)
            const PRICE_PER_1K = 0.0015;

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡å¹¶æ·»åŠ é«˜äº®åŠ¨ç”»
            const updateStat = (element, value) => {
                element.textContent = value;
                element.parentElement.classList.add('updated');
                setTimeout(() => {
                    element.parentElement.classList.remove('updated');
                }, 500);
            };

            // æ·»åŠ æ—¥å¿—æ¡ç›®
            const addLog = (type, message, details) => {
                const logItem = document.createElement('div');
                logItem.className = `log-entry ${type}`;
                const now = new Date();
                const timestamp = now.toTimeString().split(' ')[0] + '.' + String(now.getMilliseconds()).padStart(3, '0');

                logItem.innerHTML = `
                    <div class="log-timestamp">[${timestamp}]</div>
                    <div class="log-event">${message}</div>
                    <div class="log-details">${details}</div>
                `;

                tracker.appendChild(logItem);
                setTimeout(() => {
                    logItem.classList.add('visible');
                    tracker.scrollTop = tracker.scrollHeight;
                }, 50);
            };

            // 1. on_llm_start - æ˜¾ç¤ºæç¤ºè¯token
            await new Promise(resolve => setTimeout(resolve, 500));
            addLog(
                'start',
                'ğŸ“¥ on_llm_start',
                `æç¤ºè¯: "${prompt}"<br>æç¤ºè¯ tokens: ${promptTokens}`
            );
            updateStat(promptEl, promptTokens);
            updateStat(totalEl, promptTokens);

            // 2. LLMå¤„ç†ä¸­
            await new Promise(resolve => setTimeout(resolve, 1000));
            addLog(
                'start',
                'ğŸ¤– LLM PROCESSING',
                'æ¨¡å‹æ­£åœ¨ç”Ÿæˆå“åº”...<br>å‡†å¤‡æ¥æ”¶ tokens æµ'
            );

            // 3. on_llm_new_token - é€tokenè¿½è¸ª
            let accumulatedTokens = 0;
            const chars = response.split('');

            for (let i = 0; i < chars.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 100));
                accumulatedTokens++;

                // æ¯éš”å‡ ä¸ªtokenæ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
                if (i % 5 === 0 || i === chars.length - 1) {
                    updateStat(completionEl, accumulatedTokens);
                    updateStat(totalEl, promptTokens + accumulatedTokens);

                    // è®¡ç®—æˆæœ¬
                    const totalTokens = promptTokens + accumulatedTokens;
                    const cost = (totalTokens / 1000) * PRICE_PER_1K;
                    updateStat(costEl, `$${cost.toFixed(4)}`);

                    addLog(
                        'token',
                        'âš¡ on_llm_new_token',
                        `æ¥æ”¶ token #${accumulatedTokens}: "${chars[i]}"<br>ç´¯è®¡ç”Ÿæˆ: ${accumulatedTokens} tokens<br>å½“å‰æ€»æ¶ˆè€—: ${promptTokens + accumulatedTokens} tokens`
                    );
                }
            }

            // 4. on_llm_end - æœ€ç»ˆç»Ÿè®¡
            await new Promise(resolve => setTimeout(resolve, 1000));
            const finalTotal = promptTokens + accumulatedTokens;
            const finalCost = (finalTotal / 1000) * PRICE_PER_1K;

            addLog(
                'end',
                'âœ… on_llm_end',
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>
                æç¤ºè¯ tokens: ${promptTokens}<br>
                ç”Ÿæˆ tokens: ${accumulatedTokens}<br>
                <strong>æ€» tokens: ${finalTotal}</strong><br>
                é¢„ä¼°æˆæœ¬: $${finalCost.toFixed(4)}<br>
                çŠ¶æ€: æˆåŠŸ`
            );

            // 5. æ·»åŠ æ€»ç»“å¡ç‰‡
            await new Promise(resolve => setTimeout(resolve, 800));
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'log-entry end';
            summaryDiv.style.background = 'rgba(34, 197, 94, 0.15)';
            summaryDiv.innerHTML = `
                <div class="log-event">ğŸ“Š æˆæœ¬è¿½è¸ªæ€»ç»“</div>
                <div class="log-details">
                    <strong>æœ¬æ¬¡è°ƒç”¨ç»Ÿè®¡ï¼š</strong><br>
                    â€¢ è¾“å…¥: ${promptTokens} tokens Ã— $0.0005 = $${((promptTokens / 1000) * 0.0005).toFixed(4)}<br>
                    â€¢ è¾“å‡º: ${accumulatedTokens} tokens Ã— $0.0015 = $${((accumulatedTokens / 1000) * 0.0015).toFixed(4)}<br>
                    â€¢ <strong>æ€»è®¡: ${finalTotal} tokens = $${finalCost.toFixed(4)}</strong><br><br>
                    <span style="color: #4ade80;">âœ“ é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œæˆ‘ä»¬ç²¾ç¡®è¿½è¸ªäº†æ¯æ¬¡APIè°ƒç”¨çš„æˆæœ¬ï¼</span>
                </div>
            `;
            tracker.appendChild(summaryDiv);
            setTimeout(() => {
                summaryDiv.classList.add('visible');
                tracker.scrollTop = tracker.scrollHeight;
            }, 100);

            // æ¢å¤æŒ‰é’®
            await new Promise(resolve => setTimeout(resolve, 2000));
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸ”„ é‡æ–°è¿½è¸ª';
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
